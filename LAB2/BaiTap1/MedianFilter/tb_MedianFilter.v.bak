`timescale 1ns/1ps

module tb_LAB2;

    parameter WIDTH  = 554;
    parameter HEIGHT = 430;
    parameter SIZE   = WIDTH * HEIGHT;

    reg clk;
    reg rst;
    reg pixel_valid;
    reg [7:0] pixel_in;

    wire pixel_out_valid;
    wire [7:0] pixel_out;

    // ----------------------------------
    // DUT
    // ----------------------------------
    median_filter_stream #(
        .WIDTH(WIDTH)
    ) dut (
        .clk(clk),
        .rst(rst),
        .pixel_valid(pixel_valid),
        .pixel_in(pixel_in),
        .pixel_out_valid(pixel_out_valid),
        .pixel_out(pixel_out)
    );

    // ----------------------------------
    // Image buffers (TESTBENCH ONLY)
    // ----------------------------------
    reg [7:0] img_in  [0:SIZE-1];
    reg [7:0] img_out [0:SIZE-1];

    integer i;
    integer out_idx;

    // ----------------------------------
    // Clock 100 MHz
    // ----------------------------------
    initial begin
        clk = 0;
        forever #5 clk = ~clk;
    end

    // ----------------------------------
    // Main test
    // ----------------------------------
    initial begin
        pixel_valid = 0;
        pixel_in    = 0;
        out_idx     = 0;

        // Load input image
        $readmemh("pic_input.txt", img_in);

        // Reset
        rst = 1;
        #20;
        rst = 0;

        // Send pixels
        for (i = 0; i < SIZE; i = i + 1) begin
            @(posedge clk);
            pixel_valid <= 1'b1;
            pixel_in    <= img_in[i];

            if (pixel_out_valid) begin
                img_out[out_idx] <= pixel_out;
                out_idx = out_idx + 1;
            end
        end

        // Flush pipeline (vài clock cuối)
        repeat (WIDTH*2) begin
            @(posedge clk);
            pixel_valid <= 0;
            if (pixel_out_valid) begin
                img_out[out_idx] <= pixel_out;
                out_idx = out_idx + 1;
            end
        end

        // Write output image
        $writememh("pic_output.txt", img_out);

        $display("DONE - processed %0d pixels", out_idx);
        $finish;
    end

endmodule
